{% extends 'base.html' %}

{% block title %}Play $PXPT{% endblock %}

{% block extra_css %}
<style>
    .game-container {
        max-width: 500px;
        margin: 0 auto;
        width: 100%;
    }
    
    .telegram-style {
        border-radius: 10px;
        padding: 15px;
        background-color: #273746;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    @media (min-width: 768px) {
        .telegram-style {
            padding: 20px;
        }
    }
    
    .game-action-btn {
        border-radius: 8px;
        margin-bottom: 10px;
        padding: 10px;
        font-weight: 500;
        transition: all 0.2s;
        font-size: 0.9rem;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
    }
    
    @media (min-width: 576px) {
        .game-action-btn {
            padding: 12px;
            font-size: 1rem;
        }
    }
    
    .game-action-btn:hover {
        transform: translateY(-2px);
    }
    
    .tg-header {
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        margin-bottom: 20px;
        padding-bottom: 15px;
    }
    
    .resource-bar {
        height: 8px;
        margin-top: 5px;
        margin-bottom: 15px;
        border-radius: 4px;
    }
    
    .login-container {
        width: 100%;
        max-width: 350px;
        margin: 20px auto;
        padding: 15px;
    }
    
    @media (min-width: 576px) {
        .login-container {
            margin: 40px auto;
            padding: 20px;
        }
    }
    
    .stat-badge {
        font-size: 0.8rem;
        padding: 4px 8px;
        margin-right: 6px;
        margin-bottom: 6px;
        display: inline-block;
    }
    
    @media (min-width: 576px) {
        .stat-badge {
            font-size: 0.9rem;
            padding: 5px 10px;
            margin-right: 8px;
            margin-bottom: 8px;
        }
    }
    
    .result-box {
        border-radius: 8px;
        padding: 15px;
        margin-top: 20px;
        display: none;
    }
    
    .transaction-item {
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 8px;
        background-color: rgba(255, 255, 255, 0.05);
        word-break: break-word;
    }
    
    /* Responsive text sizes */
    @media (max-width: 576px) {
        h4, h5 {
            font-size: 1.1rem;
        }
        
        p, div {
            font-size: 0.9rem;
        }
        
        .small {
            font-size: 0.8rem;
        }
    }
    
    /* Improve modal responsiveness */
    .modal-dialog {
        margin: 10px;
        width: calc(100% - 20px);
        max-width: 500px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-6 mb-3 mb-md-0">
        <h1 class="fs-2 fs-md-1"><i class="fas fa-gamepad me-2"></i>Pixel Plaza Game</h1>
        <p class="lead d-none d-sm-block">Build your pixel empire and earn $PXPT tokens!</p>
        <p class="d-block d-sm-none">Build your pixel empire and earn tokens!</p>
    </div>
    <div class="col-md-6 d-flex flex-wrap justify-content-center justify-content-md-end align-items-center gap-2">
        {% if not login_required %}
        <a href="{{ url_for('tasks') }}?id={{ user.telegram_id }}" class="btn btn-outline-success btn-sm">
            <i class="fas fa-tasks me-1"></i><span class="d-none d-sm-inline">Tasks</span>
        </a>
        <a href="{{ url_for('referrals') }}?id={{ user.telegram_id }}" class="btn btn-outline-info btn-sm">
            <i class="fas fa-user-friends me-1"></i><span class="d-none d-sm-inline">Referrals</span>
        </a>
        {% endif %}
        <a href="{{ url_for('leaderboard') }}" class="btn btn-outline-primary btn-sm">
            <i class="fas fa-trophy me-1"></i><span class="d-none d-sm-inline">Leaderboard</span><span class="d-inline d-sm-none">Leaders</span>
        </a>
        <a href="{{ url_for('index') }}" class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-home me-1"></i><span>Home</span>
        </a>
    </div>
</div>

{% if login_required %}
<div class="login-container telegram-style">
    <div class="px-2 px-sm-3 py-3 py-sm-4">
        <h3 class="text-center mb-3 mb-sm-4 fs-4 fs-sm-3">Join the Game</h3>
        <p class="text-center">Log in with Telegram to start playing the Pixel Plaza Token game!</p>
        
        <div id="registration-error" class="alert alert-danger d-none mb-3"></div>
        
        <div class="text-center mb-4">
            <div id="telegram-login-pixel_plaza_bot" class="mb-3" style="margin: 0 auto;"></div>
            
            <div class="mb-3">
                <label for="referral-code" class="form-label">Referral Code <span class="text-muted">(Optional)</span></label>
                <input type="text" class="form-control" id="referral-code" placeholder="Enter referral code if you have one">
                <div class="form-text">Get a bonus 3 $PXPT by using a friend's referral code</div>
            </div>
        </div>
        
        <div class="text-center mt-3">
            <p class="text-muted small mb-1">Or play with Telegram Bot</p>
            <a href="https://t.me/{{ telegram_bot_username }}" target="_blank" class="btn btn-sm btn-outline-info">
                <i class="fab fa-telegram me-1"></i>Open Telegram Bot
            </a>
        </div>
    </div>
</div>
{% else %}

<div class="game-container">
    <!-- User Info Header -->
    <div class="telegram-style mb-4">
        <div class="tg-header d-flex justify-content-between align-items-center">
            <div>
                <h4 class="mb-1">{{ user.username }}</h4>
                <span class="badge bg-info">Level {{ game_state.level }}</span>
            </div>
            <div class="text-end">
                <h5 class="text-warning mb-1">{{ game_state.token_balance|round(2) }} $PXPT</h5>
            </div>
        </div>
        
        <!-- Resources Section -->
        <div class="resources mb-4">
            <div class="row g-2">
                <div class="col-6">
                    <div>
                        <div class="d-flex justify-content-between">
                            <span><i class="fas fa-bolt text-warning me-1"></i> Energy</span>
                            <span>{{ game_state.energy }}/100</span>
                        </div>
                        <div class="progress resource-bar">
                            <div class="progress-bar bg-warning" role="progressbar" 
                                 style="width: {{ (game_state.energy / 100) * 100 }}%">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div>
                        <div class="d-flex justify-content-between">
                            <span><i class="fas fa-paint-brush text-info me-1"></i> Pixels</span>
                            <span>{{ game_state.pixels }}</span>
                        </div>
                        <div class="progress resource-bar">
                            <div class="progress-bar bg-info" role="progressbar" 
                                 style="width: {% if game_state.pixels > 100 %}100{% else %}{{ (game_state.pixels / 100 * 100) }}{% endif %}%">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-3">
                <div class="d-flex justify-content-between">
                    <span><i class="fas fa-star text-primary me-1"></i> Experience</span>
                    <span>{{ game_state.experience }}/{{ game_state.level * 100 }}</span>
                </div>
                <div class="progress resource-bar">
                    <div class="progress-bar bg-primary" role="progressbar" 
                         style="width: {{ (game_state.experience / (game_state.level * 100)) * 100 }}%">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Stats Section -->
        <div class="mb-4">
            <h6>Your Stats:</h6>
            <div>
                <span class="badge bg-secondary stat-badge">
                    <i class="fas fa-building me-1"></i> {{ game_state.buildings_owned }} Buildings
                </span>
                <span class="badge bg-secondary stat-badge">
                    <i class="fas fa-palette me-1"></i> {{ game_state.pixel_art_created }} Artworks
                </span>
                <span class="badge bg-secondary stat-badge">
                    <i class="fas fa-fire me-1"></i> {{ game_state.daily_streak }} Day Streak
                </span>
            </div>
        </div>
        
        <!-- Game Actions -->
        <div id="action-result" class="result-box"></div>
        
        <div class="actions">
            <div class="row g-2">
                <div class="col-6 col-sm-4">
                    <button class="btn btn-primary w-100 game-action-btn game-action" data-action="daily">
                        <i class="fas fa-calendar-day d-block mb-1"></i>
                        <span class="d-none d-sm-inline">Daily Claim</span>
                        <span class="d-inline d-sm-none">Daily</span>
                    </button>
                </div>
                <div class="col-6 col-sm-4">
                    <button class="btn btn-warning w-100 game-action-btn game-action" data-action="mine">
                        <i class="fas fa-hammer d-block mb-1"></i>
                        <span class="d-none d-sm-inline">Mine Pixels</span>
                        <span class="d-inline d-sm-none">Mine</span>
                    </button>
                </div>
                <div class="col-6 col-sm-4">
                    <button class="btn btn-danger w-100 game-action-btn game-action" data-action="create">
                        <i class="fas fa-palette d-block mb-1"></i>
                        <span class="d-none d-sm-inline">Create Art</span>
                        <span class="d-inline d-sm-none">Create</span>
                    </button>
                </div>
                <div class="col-6 col-sm-4">
                    <button class="btn btn-success w-100 game-action-btn game-action" data-action="build">
                        <i class="fas fa-building d-block mb-1"></i>
                        <span>Build</span>
                    </button>
                </div>
                <div class="col-6 col-sm-4">
                    <button class="btn btn-info w-100 game-action-btn game-action" data-action="collect">
                        <i class="fas fa-piggy-bank d-block mb-1"></i>
                        <span class="d-none d-sm-inline">Collect Income</span>
                        <span class="d-inline d-sm-none">Collect</span>
                    </button>
                </div>
                <div class="col-6 col-sm-4">
                    <button class="btn btn-outline-light w-100 game-action-btn" id="wallet-btn">
                        <i class="fas fa-wallet d-block mb-1"></i>
                        <span class="d-none d-sm-inline">Set Wallet</span>
                        <span class="d-inline d-sm-none">Wallet</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Transactions -->
    <div class="telegram-style">
        <h5 class="mb-3"><i class="fas fa-history me-2"></i>Recent Activity</h5>
        
        <div id="transactions-container">
            {% if transactions %}
                {% for tx in transactions %}
                <div class="transaction-item">
                    <div class="d-flex flex-column flex-sm-row justify-content-between">
                        <div class="mb-2 mb-sm-0">
                            {% if tx.type == 'daily_reward' %}
                                <span class="badge bg-primary me-1">Daily</span>
                            {% elif tx.type == 'mining' %}
                                <span class="badge bg-warning me-1">Mining</span>
                            {% elif tx.type == 'pixel_art' %}
                                <span class="badge bg-danger me-1">Pixel Art</span>
                            {% elif tx.type == 'building_income' %}
                                <span class="badge bg-success me-1">Income</span>
                            {% elif tx.type == 'building_purchase' %}
                                <span class="badge bg-info me-1">Purchase</span>
                            {% else %}
                                <span class="badge bg-secondary me-1">{{ tx.type }}</span>
                            {% endif %}
                            <span class="small d-inline-block text-truncate" style="max-width: 180px;">{{ tx.description }}</span>
                        </div>
                        <div class="{{ 'text-success' if tx.amount > 0 else 'text-danger' }} fw-bold">
                            {{ tx.amount|round(2) }} $PXPT
                        </div>
                    </div>
                    <div class="text-muted small mt-1">
                        {{ tx.timestamp.strftime('%Y-%m-%d %H:%M') }}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p class="text-center text-muted">No transactions yet. Start playing!</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Wallet Modal -->
<div class="modal fade" id="walletModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    {% if user.wallet_address %}Update{% else %}Set{% endif %} Wallet Address
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Enter your ERC-20 compatible wallet address to receive $PXPT tokens during the airdrop.</p>
                <form id="wallet-form">
                    <div class="mb-3">
                        <label for="wallet-address" class="form-label">Wallet Address</label>
                        <input type="text" class="form-control" id="wallet-address" value="{{ user.wallet_address or '' }}" placeholder="0x...">
                        <div class="form-text">Must be a valid ERC-20 compatible wallet address starting with 0x.</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-wallet">Save Address</button>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Add resize handler for responsive layout
    window.addEventListener('resize', function() {
        updateResponsiveElements();
    });
    
    function updateResponsiveElements() {
        const isMobile = window.innerWidth < 576;
        document.querySelectorAll('.game-action').forEach(button => {
            const action = button.dataset.action;
            const buttonText = getTextForAction(action, isMobile);
            
            // Get the span (if it exists) to avoid replacing the icon
            const iconEl = button.querySelector('i');
            if (iconEl) {
                // Clear button content
                button.innerHTML = '';
                // Add back the icon
                button.appendChild(iconEl);
                // Add text with appropriate class for responsive display
                if (isMobile) {
                    button.innerHTML += `<span class="d-inline d-sm-none">${getTextForAction(action, true)}</span>
                    <span class="d-none d-sm-inline">${getTextForAction(action, false)}</span>`;
                } else {
                    button.innerHTML += getTextForAction(action, false);
                }
            }
        });
    }
    
    {% if not login_required %}
    const telegramId = '{{ user.telegram_id }}';
    
    // Game Actions
    document.querySelectorAll('.game-action').forEach(button => {
        button.addEventListener('click', function() {
            const action = this.dataset.action;
            const resultEl = document.getElementById('action-result');
            
            // Disable all action buttons
            document.querySelectorAll('.game-action').forEach(btn => {
                btn.disabled = true;
            });
            
            // Show loading state
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Loading...';
            
            // Send action to server
            fetch('/api/game_action', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: `telegram_id=${telegramId}&action=${action}`
            })
            .then(response => response.json())
            .then(data => {
                // Re-enable buttons
                document.querySelectorAll('.game-action').forEach(btn => {
                    btn.disabled = false;
                });
                
                // Reset button text
                const isMobile = window.innerWidth < 576;
                const buttonText = getTextForAction(action, isMobile);
                this.innerHTML = `<i class="fas fa-${getIconForAction(action)} d-block mb-1"></i>${buttonText}`;
                
                // Show result
                resultEl.textContent = data.message;
                resultEl.className = data.success ? 'result-box alert alert-success' : 'result-box alert alert-danger';
                resultEl.style.display = 'block';
                
                // Auto-refresh after 3 seconds
                setTimeout(() => {
                    location.reload();
                }, 3000);
            })
            .catch(error => {
                console.error('Error:', error);
                document.querySelectorAll('.game-action').forEach(btn => {
                    btn.disabled = false;
                });
                const isMobile = window.innerWidth < 576;
                const buttonText = getTextForAction(action, isMobile);
                this.innerHTML = `<i class="fas fa-${getIconForAction(action)} d-block mb-1"></i>${buttonText}`;
                resultEl.textContent = 'An error occurred. Please try again.';
                resultEl.className = 'result-box alert alert-danger';
                resultEl.style.display = 'block';
            });
        });
    });
    
    // Wallet Modal
    document.getElementById('wallet-btn').addEventListener('click', function() {
        const walletModal = new bootstrap.Modal(document.getElementById('walletModal'));
        walletModal.show();
    });
    
    // Wallet form submission
    document.getElementById('save-wallet').addEventListener('click', function() {
        const walletAddress = document.getElementById('wallet-address').value.trim();
        
        // Basic validation
        if (!walletAddress.startsWith('0x') || walletAddress.length !== 42) {
            alert('Please enter a valid ERC-20 wallet address (starting with 0x and 42 characters long)');
            return;
        }
        
        // Send to server
        fetch('/api/update_wallet', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `telegram_id=${telegramId}&wallet_address=${walletAddress}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('walletModal')).hide();
                
                const resultEl = document.getElementById('action-result');
                resultEl.textContent = 'Wallet address updated successfully!';
                resultEl.className = 'result-box alert alert-success';
                resultEl.style.display = 'block';
                
                // Auto-refresh after 2 seconds
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                alert(data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while updating your wallet address. Please try again.');
        });
    });
    {% else %}
    // Registration form submission
    document.getElementById('registration-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const username = document.getElementById('username').value.trim();
        const referralCode = document.getElementById('referral-code').value.trim();
        const errorElement = document.getElementById('registration-error');
        
        if (!username) {
            errorElement.textContent = 'Username is required';
            errorElement.classList.remove('d-none');
            return;
        }
        
        // Disable form
        document.querySelector('#registration-form button').disabled = true;
        document.querySelector('#registration-form button').innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Creating account...';
        
        // Prepare request body
        let requestBody = `username=${encodeURIComponent(username)}`;
        if (referralCode) {
            requestBody += `&referral_code=${encodeURIComponent(referralCode)}`;
        }
        
        // Send to server
        fetch('/api/web_register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: requestBody
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Redirect to game with the new telegram_id
                window.location.href = `/web-game?id=${data.telegram_id}`;
            } else {
                errorElement.textContent = data.message;
                errorElement.classList.remove('d-none');
                document.querySelector('#registration-form button').disabled = false;
                document.querySelector('#registration-form button').textContent = 'Start Playing';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            errorElement.textContent = 'An error occurred during registration. Please try again.';
            errorElement.classList.remove('d-none');
            document.querySelector('#registration-form button').disabled = false;
            document.querySelector('#registration-form button').textContent = 'Start Playing';
        });
    });
    {% endif %}
});

// Helper functions for action buttons
function getIconForAction(action) {
    switch (action) {
        case 'daily': return 'calendar-day';
        case 'mine': return 'hammer';
        case 'create': return 'palette';
        case 'build': return 'building';
        case 'collect': return 'piggy-bank';
        default: return 'gamepad';
    }
}

function getTextForAction(action, isMobile = false) {
    if (isMobile) {
        switch (action) {
            case 'daily': return 'Daily';
            case 'mine': return 'Mine';
            case 'create': return 'Create';
            case 'build': return 'Build';
            case 'collect': return 'Collect';
            default: return action;
        }
    } else {
        switch (action) {
            case 'daily': return 'Daily Claim';
            case 'mine': return 'Mine Pixels';
            case 'create': return 'Create Art';
            case 'build': return 'Build';
            case 'collect': return 'Collect Income';
            default: return action;
        }
    }
}
</script>
{% endblock %}